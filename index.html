<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Where is the ISS?</title>
    <link href="https://fonts.googleapis.com/css?family=Orbitron|Monda|Vollkorn" rel="stylesheet">
    <link href="main.css" rel="stylesheet" type="text/css" />

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script>
        "use strict";

        //var refreshLoc;
        // alert("ready!");

//        var issLat = 39.989079; // var issLon = -172.110723;
        var map;

        function refreshLocation() {
            var refreshLoc = setInterval(currLoc, 7000);
            // alert("refresh!");

        }

        function initMap(issLat = 39.989079, issLon = -172.110723) {
            //alert("map!");
            var uluru = {
                lat: issLat,
                lng: issLon
            };
            //            console.log(uluru);
            var map = new google.maps.Map(document.getElementById('map'), {
                zoom: 7,
                center: uluru,
                disableDefaultUI: true,
                zoomControl: true

            });
            var iconBase = 'imgs/iss_icon.png';
            var marker = new google.maps.Marker({
                position: uluru,
                map: map,
                icon: iconBase
            });
        }

        function currLoc() {
            var currentLocation = $.ajax({
                    url: "http://api.open-notify.org/iss-now.json",
                    dataType: "jsonp",
                    type: "GET"
                })
                .done(function(currentLocation) {
                    //console.log(currentLocation);

                    var issLat = Number(currentLocation.iss_position.latitude);
                    var issLon = Number(currentLocation.iss_position.longitude);
                    initMap(issLat, issLon);
                    $("#description").html(`<p>The International Space Station is currently flying over</p><p class="descp">LATITUDE: <span>${issLat}</span></p><p class="descp"> LONGITUDE: <span>${issLon}</span></p>`);
                })

                .fail(function(jqXHR, error, errorThrown) {
                    console.log(jqXHR);
                    console.log(error);
                    console.log(errorThrown);
                });
        }

        function currCrew() {
            var currentCrewMembers = $.ajax({
                    url: "http://api.open-notify.org/astros.json",
                    dataType: "jsonp",
                    type: "GET"
                })
                .done(function(currentCrewMembers) {
                    //console.log(currentCrewMembers);

                    var crew = currentCrewMembers;
                    //console.log(crew.people);
                    $(".numberOfAstros").text(`${crew.number}`);
                    $.each(crew.people, function(key, value) {
                        //console.log(crew.people[key].name);
                        var liOutput = '<li><a href="https://www.google.co.uk/search?q=' + crew.people[key].name + '" target="_blank">' + crew.people[key].name + '</a></li>';
                        //                console.log(liOutput);
                        $("#astronauts").append(liOutput);
                    });
                })
                .fail(function(jqXHR, error, errorThrown) {
                    console.log(jqXHR);
                    console.log(error);
                    console.log(errorThrown);
                });
        }

        function geocodeAddress(geocoder, address) {

            if (geocoder !== undefined) {
                geocoder.geocode({
                    'address': address
                }, function(results, status) {
                    if (status === 'OK') {
                        var myLon = results[0].geometry.viewport.b.f;
                        var myLat = results[0].geometry.viewport.f.f;
                        var params = {
                            lat: myLat,
                            lon: myLon,
                            n: 3
                        }
                        var nextPass = $.ajax({
                                url: "http://api.open-notify.org/iss-pass.json",
                                data: params,
                                dataType: "jsonp",
                                type: "GET"
                            })
                            .done(function(nextPass) {
                                // console.log(nextPass);
                                $.each(nextPass.response, function(key, value) {
                                    var issPass = nextPass.response[key].risetime;

                                    console.log(issPass);

                                    //                        function convertUnixTimeCallback(result) {
                                    //                            console.log(result);
                                    //                        }
                                    var threePasses = $.ajax({
                                            url: "http://www.convert-unix-time.com/api?timestamp=" + issPass + "&returnType=jsonp&callback=convertUnixTimeCallback",
                                            // data: issPass,
                                            dataType: "jsonp",
                                            type: "GET"
                                        })
                                        .done(function(threePasses) {
                                            //alert("passesOverhead!");
                                            console.log(threePasses);
                                        })
                                        .fail(function(jqXHR, error, errorThrown) {
                                            console.log(jqXHR);
                                            console.log(error);
                                            console.log(errorThrown);
                                        });
                                })
                            })
                            .fail(function(jqXHR, error, errorThrown) {
                                console.log(jqXHR);
                                console.log(error);
                                console.log(errorThrown);
                            });
                    } else {
                        alert('Geocode was not successful for the following reason: ' + status);
                    };
                });
            }
        }

        //            document.getElementById('submit').addEventListener('click', function() { // var geocoder = new google.maps.Geocoder(); // geocodeAddress(geocoder); // });
        $('#submit').on('click', function() {
            var geocoder = new google.maps.Geocoder();
            var address = $('#address').value();
            geocodeAddress(geocoder, address);
        });

        $(currLoc());
        $(refreshLocation());
        $(currCrew());
        $(geocodeAddress());
    </script>

</head>

<body>
    <header>
        <h1>The International Space Station</h1>
        <div>
            <iframe src="https://www.youtube.com/embed/xOsOifg4Mm0?rel=0" frameborder="0" allowfullscreen></iframe>
        </div>
        <p>The International Space Station travels around our planet at an average speed of 17,227 miles per hour (about 5 miles per second), making one rotation around the earth every 92 minutes. At 220 miles above the surface, the crew onboard the space station have incredible views of the planet, solar system and galaxy. </p>
        <p>From the surface of the Earth, the International Space Station looks like a very fast moving plane - a steady white light moving across the sky. Except for the moon, it is the brightest object in the night sky and is easy to see if you know when and where to look.</p>

    </header>
    <main>
        <section class="whereISS">
            <h3>Where is the</h3>
            <h2>International Space Station?</h2>
            <p>The map below is updated every 7 seconds with the location of the ISS as it travels around the earth.</p>
            <div id="map"></div>
            <div id="description"></div>
        </section>
        <section class="crew">
            <h2>The Crew</h2>

            <p>The International Space Station is truly an exciting <a href="https://www.nasa.gov/mission_pages/station/cooperation/index.html" target="blank">international endeavor</a> and carries multinational crews of astronauts from the United States, Russia, Europe, Japan, and Canada. </p>
            <p>There are currently <span class="numberOfAstros"></span> astronauts onboard the space station:</p>

            <ul id="astronauts"></ul>
            <a href="https://www.nasa.gov/mission_pages/station/expeditions/expedition53/index.html" target="_blank">Click here to visit the NASA website</a> to learn more about the crew of the International Space Station.
        </section>

        <!-- <section class="news">
            <h2>ISS News</h2>
            <iframe src="http://output10.rssinclude.com/output?type=iframe&amp;id=1153762&amp;hash=6812144aa2b011c2fea4ea5f8bb582f7"></iframe>
        </section>-->

        <section class="viewISS">
            <h3>View the</h3>
            <h2>International Space Station</h2>
            <p>When will the space station be traveling overhead? <br>Submit your location below to find out!</p>


            <form action="#" class="js-search-form">
                <label for="address">Address:</label>
                <input type="textbox" value="Timnath, CO" id="address" class="js-query">
                <input type="button" id="submit" value="Geocode">
            </form>

            <p id="nextPass"></p>
        </section>

    </main>
    <footer>Footer content here - contact information</footer>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAjzNAJ2vuaVwR0_QnBx9XrgT1my25DLFg&callback=initMap" type="text/javascript"></script>

    <script src="https://apis.google.com/js/api.js"></script>
    <!--    <script src="main-js.js"></script>-->



</body>

</html>
